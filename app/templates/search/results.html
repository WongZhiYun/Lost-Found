<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Search Results</title>
  <style>
    .card { border: 1px solid #ddd; padding: 8px; margin: 8px 0; display:flex; gap:12px; }
    .thumb { width: 100px; height: 80px; object-fit:cover; }
    .meta { flex:1; }
    .score { font-weight: bold; }
  </style>
</head>
<body>

  <!-- keyword search -->
  <form method="get" action="{{ url_for('search.search_page') }}">
    <input type="text" name="q" value="{{ q }}" placeholder="Search keywords..." />
    <select name="category">
      <option value="">All categories</option>
      <option value="Electronics" {% if category=='Electronics' %}selected{% endif %}>Electronics</option>
      <option value="Stationery" {% if category=='Stationery' %}selected{% endif %}>Stationery</option>
    </select>
    <button type="submit">Search</button>
  </form>

  <!-- image search -->
  <form method="post" action="{{ url_for('search.search_by_image') }}" enctype="multipart/form-data" style="margin-top:12px;">
    <input type="file" name="file" accept="image/*" required/>
    <button type="submit">Search by Image</button>
  </form>

  <!-- Combined form (q + file + alpha) -->
  <form method="post" action="{{ url_for('search.combined_search') }}" enctype="multipart/form-data" style="margin-top:12px;">
    <input type="text" name="q" value="{{ q }}" placeholder="Keywords (optional)"/>
    <input type="file" name="file" accept="image/*"/>
    <label>Image weight (alpha): <input type="number" name="alpha" min="0" max="1" step="0.1" value="0.6"/></label>
    <button type="submit">Combined Search</button>
  </form>

 <hr/>

{% if results %}
    {% for item in results %}
      {% set r = item.report if item.report is defined else item[0] %}
      {% set ts = item.text_score if item.text_score is defined else 0 %}
      {% set is_ = item.image_score if item.image_score is defined else 0 %}
      {% set fs = item.final_score if item.final_score is defined else (ts) %}
      <div class="card">
        <div>
          {% if r.image_filename %}
            <img class="thumb" src="{{ url_for('static', filename='uploads/' ~ r.image_filename) }}" alt="thumb" />
          {% else %}
            <img class="thumb" src="{{ url_for('static', filename='placeholder.png') }}" alt="no image"/>
          {% endif %}
        </div>
        <div class="meta">
          <div><strong>{{ r.title }}</strong> — {{ r.category or 'N/A' }}</div>
          <div>{{ r.place or '' }} — {{ r.created_at.strftime('%Y-%m-%d') if r.created_at else '' }}</div>
          <p>{{ r.description[:180] }}{% if r.description|length > 180 %}...{% endif %}</p>
        </div>
        <div style="text-align:right;">
          <div class="score">Final: {{ (fs*100)|round(0) }}%</div>
          <div>Text: {{ (ts*100)|round(0) }}%</div>
          <div>Image: {{ (is_*100)|round(0) }}%</div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No results.</p>
  {% endif %}
</body>
</html>
